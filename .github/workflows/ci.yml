name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Conan
      run: |
        pip install conan
        
    - name: Configure Conan for C++20
      run: |
        conan profile detect --force
        # Override to C++20 (not gnu20 to match CMAKE_CXX_EXTENSIONS=OFF)
        sed -i 's/compiler\.cppstd=.*/compiler.cppstd=20/' ~/.conan2/profiles/default || true
        echo "compiler.cppstd=20" >> ~/.conan2/profiles/default || true
    
    - name: Build project
      run: |
        chmod +x scripts/build.sh scripts/test.sh scripts/start-influxdb.sh scripts/stop-influxdb.sh
        ./scripts/build.sh Release
      
    - name: Start InfluxDB
      run: |
        ./scripts/start-influxdb.sh
        
    - name: Run tests
      run: |
        ./scripts/test.sh
        
    - name: Stop InfluxDB
      if: always()
      run: |
        ./scripts/stop-influxdb.sh

  macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Conan
      run: |
        pip install conan
        
    - name: Configure Conan for C++20
      run: |
        conan profile detect --force
        # Override to C++20 (not gnu20 to match CMAKE_CXX_EXTENSIONS=OFF)
        sed -i '' 's/compiler\.cppstd=.*/compiler.cppstd=20/' ~/.conan2/profiles/default || true
        echo "compiler.cppstd=20" >> ~/.conan2/profiles/default || true
    
    - name: Build project
      run: |
        chmod +x scripts/build.sh scripts/test.sh scripts/start-influxdb.sh scripts/stop-influxdb.sh
        ./scripts/build.sh Release
      
    - name: Install Docker (try Colima)
      id: docker-setup
      continue-on-error: true
      run: |
        echo "docker_available=false" >> $GITHUB_OUTPUT
        echo "Attempting to set up Docker via Colima..."
        # Install Docker CLI and Colima (headless Docker for macOS)
        brew install docker colima docker-compose || true
        
        # Try to start Colima (may fail on GitHub Actions runners)
        if colima start > /dev/null 2>&1; then
          # Wait for Docker to be ready
          timeout=60
          elapsed=0
          docker_ready=false
          while [ $elapsed -lt $timeout ]; do
            if docker info > /dev/null 2>&1; then
              echo "Docker is ready!"
              docker_ready=true
              break
            fi
            sleep 2
            elapsed=$((elapsed + 2))
          done
          
          if [ "$docker_ready" = "true" ] || docker info > /dev/null 2>&1; then
            echo "docker_available=true" >> $GITHUB_OUTPUT
          else
            echo "Docker installed but not responding"
            echo "docker_available=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "Colima failed to start (known issue on GitHub Actions macOS runners)"
          echo "docker_available=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Start InfluxDB
      if: steps.docker-setup.outputs.docker_available == 'true'
      run: |
        ./scripts/start-influxdb.sh
        
    - name: Run tests
      if: steps.docker-setup.outputs.docker_available == 'true'
      run: |
        ./scripts/test.sh
    
    - name: Skip integration tests (Docker unavailable)
      if: steps.docker-setup.outputs.docker_available != 'true'
      run: |
        echo "⚠️  Docker/Colima unavailable on macOS runner - skipping integration tests"
        echo "Build completed successfully, but integration tests were skipped."
        echo "This is a known limitation of Docker on macOS GitHub Actions runners."
        
    - name: Stop InfluxDB
      if: always() && steps.docker-setup.outputs.docker_available == 'true'
      run: |
        ./scripts/stop-influxdb.sh || true
    
    - name: Stop Colima
      if: always()
      run: |
        colima stop || true
        colima delete -f || true

  windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache InfluxDB
      uses: actions/cache@v4
      with:
        path: |
          influxdb-1.8.10-1
          influxdb-1.8.10_windows_amd64.zip
        key: influxdb-1.8.10-windows-${{ runner.os }}
        restore-keys: |
          influxdb-1.8.10-windows-
    
    - name: Install Conan
      run: |
        pip install conan
        
    - name: Configure Conan for C++20
      shell: bash
      run: |
        conan profile detect --force
        # Override to C++20 for MSVC (uses simple "20" not "gnu20")
        sed -i 's/compiler\.cppstd=.*/compiler.cppstd=20/' ~/.conan2/profiles/default || true
        echo "compiler.cppstd=20" >> ~/.conan2/profiles/default || true
    
    - name: Build project
      run: |
        scripts\build.bat Release
      
    - name: Start InfluxDB
      run: |
        scripts\start-influxdb.bat
        
    - name: Run tests
      run: |
        scripts\test.bat
        
    - name: Stop InfluxDB
      if: always()
      run: |
        scripts\stop-influxdb.bat
